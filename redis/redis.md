# Redis
## 主从库数据如何实现一致
- 高性能的必然要求，服务尽量不要中断，因此要有主从库
- 第一次同步，从库调用`replicaof 主库IP 6379`
1. 从库给主库发送psync命令包含参数`runID=?, offset=-1`
2. 主库准备好，发送FULLRESYNC，包含参数自己的runID和offset
- 主库传送RDB文件，从库读RDB到内存
1. 主库执行bgsave命令，生产最新的RDB文件，把RDB文件传送从库
2. 从库把本地数据清空，把RDB文件读进内存
3. 在同步过程中，主库没有被阻塞，主库会把同步过程中产生的新的写命令存入`replication buffer`
- 主库把`replication buffer`中的命令传给从库
- 主从级联模式
1. 分担主库全量复制的压力
2. 主库fork子进程生成RDB文件会阻塞
3. 主库传送RDB文件时会占用带宽
4. 通过`主-从-从`的模式将主库生产RDB已经传输的压力放在从库上
- 基于长连接的命令传播
- 主从库网络断连
1. 断连时主库会把收到的写操作命令写入到`repl_backlog_buffer`这个缓冲区
2. `repl_backlog_buffer`是一个环形缓冲区，主库会记录自己写到的位置，从库会记录自己读到的位置
3. 连接重新连上后，从库发送的psync中包含`slave_repl_offset`,主库收到后对比自己的`master_repl_offset`,发送两者之间的命令
4. 增量复制(重连以后)
5. `repl_backlog_size`设置的大一点，令其等于`主库写入命令速度*操作大小-主从库间网络传输速度*操作大小`*2
6. 一个从库如果和主库断连时间过长，造成它在主库`repl_backlog_buffer`的`slave_repl_offset`位置上的数据已经被覆盖掉了，此时从库和主库间将进行全量复制。

- 主从全量同步使用RDB而不使用AOF的原因
1. RDB是压缩过的文件，AOF是命令，可能有冗余
2. 从库加载RDB文件时很快，读AOF时需要一条一条执行，慢！